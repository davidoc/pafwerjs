<!DOCTYPE html>
<html>
  <head>
    <title>Password generator</title>
    <script src="/js/crypto-sha256.js"></script>
    <script src="/js/wordlist.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
    <script type="text/javascript">
      (function(exports, $) {
        var TOTAL_EVENTS = 1000
          , events_left = TOTAL_EVENTS
          , buffer
          , random_2 = function(bits) {
              var hex = buffer.slice(0, Math.ceil(bits/4));
              buffer = Crypto.SHA256(buffer);
              return parseInt(hex, 16);
            };

        exports.random = function(max) {
          var bits = Math.ceil(Math.log(max)/Math.log(2))
          var n;

          do {
            n = random_2(bits);
          } while ( n >= max );
          return n;
        };

        exports.randomChoice = function(ary) {
          var index = exports.random(ary.length);
          return ary[index];
        };

        exports.randomPassword = function(n) {
          var words = []
          while ( n-- ) {
            words.push(exports.randomChoice(wordlist));
          }
          return words.join(" ");
        };

        exports.sentencePassword = function(template) {
          sentence = [];
          for ( var i = 0; i < template.length; i++ ) {
            sentence.push(exports.randomChoice(words[template[i] + "s"]));
          }
          return sentence.join(" ");
        };

        exports.templateEntropy = function(template) {
          var entropy = 0;
          for ( var i = 0; i < template.length; i++ ) {
            entropy += Math.log(words[template[i] + "s"].length)/Math.log(2);
          }
          return entropy;
        };

        $(document).ready(function() {
          var more_entropy_progress_div = $('#more_entropy .progress div');
          $('#generate button').click(function() {
            $('#generate .password').text(exports.sentencePassword(['adjective', 'noun', 'verb', 'adjective', 'noun']));
          });
          $(document).mousemove(function(event) {
            var x = event.clientX
              , y = event.clientY
              , ms = event.timeStamp;
            buffer = Crypto.SHA256(buffer + x + y + ms);
            events_left--;
            if (  events_left == 0 ) {
              $('#more_entropy').hide();
              $('#generate').show();
            }
            else if ( events_left > 0 && events_left % 10 == 0 )
            {
              more_entropy_progress_div.css('width', ((TOTAL_EVENTS - events_left)/TOTAL_EVENTS * 100) + '%');
            }
          });
        });
      })(window, jQuery);
    </script>
    <style>
      .progress {
        width: 300px;
        height: 50px;
        border: 1px solid black;
      }
      .progress > div {
        background-color: orange;
        height: inherit;
      }
    </style>
  </head>
  <body>
    <div id="generate" style="display: none;">
      <div class="password"></div>
      <button>Generate</button>
    </div>
    <div id="more_entropy">
      Move your mouse around
      <div class="progress">
        <div style="width: 0"></div>
      </div>
    </div>
  </body>
</html>
